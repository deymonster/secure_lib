# Secure T-Box Control - Project Plan

## 0. Архитектура и Логика работы (Architecture & Workflow)
**Контекст**: Приложение устанавливается на Головное Устройство (ГУ/HU) автомобиля Android.

1. **Получение VIN**: Приложение считывает VIN номер автомобиля (через `getprop` или системные вызовы).
2. **Запрос конфигурации**: 
   - Приложение отправляет VIN на внешний управляющий сервер (Server).
   - В ответ получает конфигурацию (JSON/XML), содержащую необходимые правила маршрутизации.
3. **Подключение к T-Box**:
   - Приложение инициирует SSH-соединение с Телематическим Блоком (T-Box).
   - **IP адрес T-Box**: `172.16.2.97` (Фиксированный/Static).
   - Учетные данные (User/Pass/Key) используются из защищенного хранилища (нативная библиотека).
4. **Применение правил**:
   - На основе полученного конфига приложение формирует и выполняет команды `iptables` на T-Box через установленную SSH-сессию.
   - Цель: перенаправление трафика или настройка сетевого доступа.

## 1. Нативная библиотека (The Core / Native Layer)
Вся критическая логика (бизнес-логика, ключи, команды) выносится из Java/Kotlin в C/C++ (.so библиотеку).

### Функциональность (Logic)
- [x] **Библиотеки**: Статическая линковка `libssh` (вместо libssh2, но функционально эквивалентно), `OpenSSL`, `zlib`.
- [x] **SSH Manager**: Логика подключения, аутентификации и выполнения команд.
- [x] **VIN Reader**: Получение VIN через `getprop` или чтение файлов.
- [x] **API Client**: Реализация HTTPS запросов через `libcurl` (статически) для получения конфигов.
- [x] **JNI Interface**: Экспорт функций для вызова из Java (реализовано в `native-lib.cpp` и `tbox_logic`).

### Меры защиты (Security Measures)
- [~] **Шифрование строк (String Encryption)**:
  - [x] Реализовать XOR/AES механизм (класс `Obfuscator`).
  - [~] Заменить открытые строки ("root", IP, URL) на Hex-массивы:
    - [x] Прототип в `test_main.cpp` (runtime encryption).
    - [ ] Полная замена литералов на статические байт-массивы (header-file generation).
- [ ] **Anti-Debug / Anti-Frida**:
  - [~] Проверка `TracerPid` (status).
  - [ ] `ptrace(PTRACE_TRACEME)`.
  - [ ] Проверка времени выполнения (timing checks).
  - [ ] Аварийное завершение при обнаружении.
- [ ] **Скрытие импортов (Hidden Imports)**:
  - [ ] Динамическая загрузка функций (`dlsym`, `dlopen`) для `socket`, `connect`, `write` и т.д.
- [ ] **Обфускация (Obfuscation)**:
  - [ ] Control Flow Flattening (через флаги компилятора или макросы, если O-LLVM недоступен).
  - [ ] Strip Symbols (удаление отладочной информации).

## 2. Java/Kotlin слой (The App Layer)
Максимально "глупый" интерфейс.

- [ ] **Интеграция**: Вызов Native методов через JNI.
- [ ] **R8 / ProGuard**: Включить обфускацию и минификацию.
- [ ] **Integrity Check**: Проверка подписи приложения.
- [ ] **Certificate Pinning**: Защита SSL соединений.

## 3. Сетевая безопасность (Network Security)
- [x] **SSH**: Использование нативной библиотеки (libssh).
- [x] **API**: Использование нативного клиента (libcurl).

---
### Текущий статус
- Среда сборки настроена (CMake, NDK).
- Логика рефакторизована в `tbox_logic` и отделена от `test_main`.
- Реализован JNI-интерфейс в `native-lib.cpp` для вызова `sendVin` и `performSetup`.
- `CMakeLists.txt` обновлен для сборки разделяемой библиотеки (`.so`) с поддержкой JNI.

### Следующий шаг
Интеграция в Android приложение (Java/Kotlin вызовы) и полное шифрование строк (замена литералов).